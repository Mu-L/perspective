import"https://cdn.jsdelivr.net/npm/@finos/perspective-viewer@3.2.1/dist/cdn/perspective-viewer.js";import"https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-datagrid@3.2.1/dist/cdn/perspective-viewer-datagrid.js";import"https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-d3fc@3.2.1/dist/cdn/perspective-viewer-d3fc.js";import t from"https://cdn.jsdelivr.net/npm/@finos/perspective@3.2.1/dist/cdn/perspective.js";const e=2e4,i=performance.now(),s={id:"integer",side:"string",security:"string",price:"float",timestamp:"datetime",status:"string"};async function a(t,e){const i=await t.view(e),s=await i.to_columns();return await i.delete(),s}class n{constructor(t,e){this._memo=void 0,this._side=e,this._table=t,this._price_view=t.view({columns:["price"],group_by:["security"],aggregates:{price:"buy"===e?"max":"min"},filter:[["side","==",e],["status","==","open"]]})}async best_open_price(){if(void 0===this._memo){const t=await this._price_view,{price:e}=await t.to_columns({leaves_only:!0});this._memo=0===e.length?20:e[0]}return this._memo}async matched_orders(t){const e="buy"===this._side?"desc":"asc",i="buy"===this._side?">":"<";return await a(this._table,{columns:["id"],filter:[["side","==",this._side],["status","==","open"],["price",i,t]],sort:[["price",e],["timestamp","asc"]]})}reset(){this._memo=void 0}}class o{async consume(){await new Promise((t=>{this._resolve=t}))}emit(){this._resolve&&(this._resolve(),this._resolve=void 0)}}function r(t){const e=document.querySelector("button");if(void 0!==t){const i=10*(10*t).toFixed(0);e.textContent=`Generating trades ${i}%`}else e.textContent="Reset"}const c=[async function(){const e=await t.worker(),i=await t.worker(),a=await e.table(s,{index:"id"}),n=await a.view();return{market_table:a,gui_table:await i.table(n,{index:"id"})}}(),async function(){const t=await fetch("layouts.json");return await t.json()}()],[{market_table:d,gui_table:_},l]=await Promise.all(c),h=new class{constructor(t,e){this._id=1,this._table=t,this._model=e,this._buy_book=new n(t,"buy"),this._sell_book=new n(t,"sell"),this._stop_signal=new o}async stop(){this._id<e&&(this._id=e,await this._stop_signal.consume()),this._id=1}async poll(t){for(await this._run_market_step();this._id<5e3;)await this._run_market_step(t);t?.(),this._stop_signal.emit(),this._id<e&&setTimeout(this.poll.bind(this),50)}async _run_market_step(t){await this._generate_trades()&&(await this._clear_trades(),await this._expire_trades()),this._buy_book.reset(),this._sell_book.reset(),t?.(this._id/5e3)}async _generate_trades(){const t=[],e=new Date(i+200*this._id);for(let i=0;i<10;i++){const{side:i,discount:s}=this._model(),a="buy"===i?this._sell_book:this._buy_book,n=await a.best_open_price();t.push({security:"Prospective Co",status:"open",id:this._id++,price:s+n,side:i,timestamp:e})}if(t.length>0)return await this._table.update(t),!0}async _clear_trades(){const t=await this._sell_book.best_open_price(),e=await this._buy_book.best_open_price(),{id:i}=await this._buy_book.matched_orders(t),{id:s}=await this._sell_book.matched_orders(e),a=Math.min(i.length,s.length),n=Array(2*a).fill("closed"),o=i.slice(0,a).concat(s.slice(0,a));o.length>0&&await this._table.update({status:n,id:o})}async _expire_trades(){const t=await a(this._table,{columns:["id"],filter:[["status","==","open"],["id","<",this._id-100]]});t.id.length>0&&(t.status=Array(t.id.length).fill("expired"),await this._table.update(t))}}(d,(function(){const[t,e]=Math.random()>.5?["buy",-1]:["sell",1],i=function(t){const e=Math.random(),i=Math.random(),s=Math.sqrt(-2*Math.log(e)),a=2*Math.PI*i,n=s*Math.cos(a);return Math.sin(a),2*t+2*n}(e);return{side:t,discount:i}})),p=!/(iPad|iPhone|iPod)/g.test(navigator.userAgent),u=document.querySelector("select"),m=document.querySelector("button"),w=document.querySelector("perspective-viewer");w.load(_),w.restore({theme:"Pro Dark",settings:p,...l[0]}),await h.poll(r);for(const b of l){const t=document.createElement("option");t.value=b.title,t.textContent=b.title,u.appendChild(t)}m.addEventListener("click",(()=>{!async function(t,e,i){await t.stop(),await i.size(),await e.clear(),await i.clear(),await t.poll(r)}(h,d,_)})),u.addEventListener("change",(async t=>{const e=l.find((e=>e.title===t.target.value));await w.restore(e)}));